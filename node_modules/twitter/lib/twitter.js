var sys = require('sys');
var oauth = require('oauth');

var _celeb_twitterConsumerKey = "8ISzfmTIQ6GVCGEzC2Eeng";
var _celeb_twitterConsumerSecret = "nph2lw6hIqjxtB7LJqKwk1VYg37hiJbMOCn6pmcY";

var _nba_twitterConsumerKey = "zR910wq1JumaQZilfaci3g";
var _nba_twitterConsumerSecret = "qxzTfYA3Tljbm3SIfDdtBRWQINB0o2ZHv1bgWQv41Q";

var _nfl_twitterConsumerKey = "CUwOWAClLQYTbJamULqyvQ";
var _nfl_twitterConsumerSecret = "Fnre6tRVCPi2pIHElOrpTVufd3H9vsg5fGtggZ1Evo";

var _callbackUrl = "http://192.168.1.101:3000/success";

function consumer(consumerKey, consumerSecret){
	return new oauth.OAuth("https://api.twitter.com/oauth/request_token",
					"https://api.twitter.com/oauth/access_token",
					consumerKey,
					consumerSecret,
					"1.0A",
					null,
					"HMAC-SHA1");
}

module.exports = {
	getRequestToken: function (requestTokenCallback) {
		consumer().getOAuthRequestToken( function (error, oauthToken, oauthTokenSecret, results){
			if (error){
				console.log("Error getting OAuth request token : " + sys.inspect(error));
			} else {
				console.log(oauthToken);
				console.log(oauthTokenSecret);
				requestTokenCallback(oauthToken,oauthTokenSecret);
			}
		});
	},

	getAuthAccessToken: function (user, oauthVerifier, authAccessCallback) {
		var accessToken = '';
		var accessTokenSecret = '';
	
		consumer().getOAuthAccessToken(user.oauthRequestToken, user.oauthRequestTokenSecret, oauthVerifier, function(error, oauthAccessToken, oauthAccessTokenSecret, results) {
    		console.log('--getAuthAccessToken--');
    		console.log(user.oauthRequestToken);
    		console.log(user.oauthRequestTokenSecret);
    		console.log(oauthVerifier);
    	
	    	if (error) {
		  		accessToken = "159904250-k8zLnOWAo5kEvs5W1sTSBYnvjb6oLSSNMHbJKc6O";
	      		accessTokenSecret= "b5KQOE5AB7DmXWtHhva3mRHi5v3oD9LQp6h2XWACZ0";
	    	} else {
		  		accessToken = oauthAccessToken;
	      		accessTokenSecret= oauthAccessTokenSecret;
	    	}
	
	    	authAccessCallback(accessToken, accessTokenSecret);
		});
	},

	getHomeTimeline: function (site, callback) {
		consumer().get("http://api.twitter.com/1/statuses/friends_timeline.json?count=30", site.access_token, site.access_token_secret, function (error, data, response) {
        	if (error) {
				console.log('we are in error folks');
        	} else {
				var tweetArray = JSON.parse(data);
				var tweets = [];
			
				for (var i=0; i < tweetArray.length; i++) {
					var tweet = {
						user: tweetArray[i].user.name,
						text: tweetArray[i].text,
						profileImageUrl: tweetArray[i].user.profile_image_url,
			        	screenName: tweetArray[i].user.screen_name
					};
					tweets.push(tweet);
				}

         		callback(tweets);
      		}  
		});
	},
	
	getUserStream: function(category, access_token, access_token_secret, streamCallback) {
		var consumer_key = '';
		var consumer_secret = '';
		if (category === 'celebrity') {
			consumer_key = _celeb_twitterConsumerKey;
			consumer_secret = _celeb_twitterConsumerSecret;
		} else if (category === 'nba') {
			consumer_key = _nba_twitterConsumerKey;
			consumer_secret = _nba_twitterConsumerSecret;
		} else if (category === 'nfl') {
			consumer_key = _nfl_twitterConsumerKey;
			consumer_secret = _nfl_twitterConsumerSecret;
		} else {
			return;
		}
		var request = consumer(consumer_key, consumer_secret).get("https://userstream.twitter.com/2/user.json", access_token, access_token_secret);
		request.addListener('response', function (response) {
			response.setEncoding('utf8');
			response.addListener('data',  function (chunk) {
			    try {
			    	if (chunk.length > 0) {
					    var tweet = JSON.parse(chunk);
						
						console.log(chunk);
					    if (tweet.hasOwnProperty('text')) {
						    var data = {
						    	user_name: tweet.user.screen_name,
						    	text: tweet.text,
						    	profile_image_url: tweet.user.profile_image_url,
						    	full_name: tweet.user.name,
						    	tweet_id: tweet.id,
						    	created_on: tweet.created_at
						    };
							streamCallback(data);
						}
					}
				} catch (ex) {
					console.log(ex);
				}
			});
			response.addListener('end', function() {
				console.log('----end----');
			});
		});
		request.end();
	},
	
	
	getUsers: function(access_token, access_token_secret, ids, callback) {
		consumer().get("http://api.twitter.com/1/users/lookup.json?user_id=" + ids, access_token, access_token_secret, function (error, data, response) {
        	if (error) {
				console.log('we are in error folks');
        	} else {
        		var users = JSON.parse(data); 
				
         		callback(null, users);
      		}  
		});
	},
	
	getFriendsIds: function(access_token, access_token_secret, screen_name, callback) {
		consumer().get("https://api.twitter.com/1/friends/ids.json?screen_name=" + screen_name, access_token, access_token_secret, function (error, data, response) {
        	if (error) {
				console.log('we are in error folks');
        	} else {
        		var ids = JSON.parse(data); 
				
         		callback(null, ids);
      		}  
		});
	},
	
	getUserDetails: function(access_token, access_token_secret, user_id, callback) {
		consumer().get("http://api.twitter.com/1/users/show.json?user_id=" + user_id, access_token, access_token_secret, function (error, data, response) {
        	if (error) {
				console.log('we are in error folks');
        	} else {
        		console.log(data);
        		var user = JSON.parse(data); 
	
			    var data = {
			    	user_name: user.screen_name,
			    	full_name: user.name,
			    	description: user.description,
			    	id: user.id
			    };
				
         		callback(null, data);
         		
      		}  
		});
	},
	
	getUserTweets: function(access_token, access_token_secret, user_id, callback) {
		consumer().get("https://api.twitter.com/1/statuses/user_timeline.json?count=100&user_id=" + user_id, access_token, access_token_secret, function (error, data, response) {
        	if (error) {
				console.log('error retrieving tweets ' + sys.inspect(error));
        	} else {
        		//console.log(data);
        		var tweetArray = JSON.parse(data);
				var tweets = [];
			
				for (var i=0; i < tweetArray.length; i++) {
					var tweet = {
			        	user_name: tweetArray[i].user.screen_name,
				    	text: tweetArray[i].text,
				    	profile_image_url: tweetArray[i].user.profile_image_url,
				    	full_name: tweetArray[i].user.name,
				    	tweet_id: tweetArray[i].id,
				    	created_on: tweetArray[i].created_at
					};
					tweets.push(tweet);
				}
				
         		callback(null, tweets);
      		}  
		});
	}
};